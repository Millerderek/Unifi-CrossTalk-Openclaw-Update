# /etc/nginx/sites-available/unifi-toolkit
#
# VPS Nginx config — proxies public internet traffic to your local machine
# via Tailscale private network. No firewall holes needed on local machine.
#
# Prerequisites on VPS:
#   - Nginx installed: sudo apt install nginx
#   - Certbot installed: sudo apt install certbot python3-certbot-nginx
#   - DNS A record for toolkit.yourdomain.com → VPS public IP
#   - Tailscale running on both VPS and local machine
#
# Replace:
#   100.x.x.x        → your LOCAL machine's Tailscale IP (run: tailscale ip -4)
#   toolkit.yourdomain.com → your actual domain

# Redirect HTTP → HTTPS
server {
    listen 80;
    server_name toolkit.yourdomain.com webhooks.yourdomain.com;
    return 301 https://$host$request_uri;
}

# Main toolkit dashboard + API
server {
    listen 443 ssl http2;
    server_name toolkit.yourdomain.com;

    # SSL — managed by Certbot (run: sudo certbot --nginx -d toolkit.yourdomain.com)
    ssl_certificate     /etc/letsencrypt/live/toolkit.yourdomain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/toolkit.yourdomain.com/privkey.pem;
    include             /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam         /etc/letsencrypt/ssl-dhparams.pem;

    # Security headers
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options DENY always;
    add_header X-Content-Type-Options nosniff always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # Proxy to local machine via Tailscale
    location / {
        proxy_pass         http://100.x.x.x:8000;
        proxy_http_version 1.1;
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;

        # WebSocket support (for Network Pulse live updates)
        proxy_set_header   Upgrade           $http_upgrade;
        proxy_set_header   Connection        "upgrade";

        proxy_read_timeout    300s;
        proxy_connect_timeout 30s;
        proxy_send_timeout    300s;

        # Buffer settings for large event payloads
        proxy_buffering    off;
        proxy_buffer_size  128k;
        proxy_buffers      4 256k;
    }
}

# Webhook-only endpoint (Access & Protect POST here)
# Separated so you can apply different rate limits / auth rules
server {
    listen 443 ssl http2;
    server_name webhooks.yourdomain.com;

    ssl_certificate     /etc/letsencrypt/live/toolkit.yourdomain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/toolkit.yourdomain.com/privkey.pem;
    include             /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam         /etc/letsencrypt/ssl-dhparams.pem;

    # Only allow POST to webhook paths — block everything else
    location /activity/webhooks/ {
        # Rate limit: 60 webhook events per minute per IP
        limit_req zone=webhooks burst=20 nodelay;

        # Only allow POST
        limit_except POST {
            deny all;
        }

        proxy_pass         http://100.x.x.x:8000;
        proxy_http_version 1.1;
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
        proxy_read_timeout 60s;

        # Forward UniFi signature headers
        proxy_pass_header  X-Signature;
        proxy_pass_header  X-Hub-Signature-256;
    }

    # Block everything else on the webhook domain
    location / {
        return 403;
    }
}
