---
# UniFi Toolkit — Docker Compose (VPS + Tailscale deployment)
#
# Services:
#   tailscale   — Tailscale mesh VPN sidecar (reaches your local UniFi network)
#   app         — UI Toolkit FastAPI application
#   nginx       — Reverse proxy + SSL termination (public HTTPS)
#
# Quick start:
#   1. cp .env.example .env && nano .env
#   2. docker compose up -d
#   3. docker compose exec app alembic upgrade head
#   4. Point your domain DNS A record → this VPS public IP
#
# Tailscale auth key: https://login.tailscale.com/admin/settings/keys
# Create an ephemeral reusable key — paste into .env as TS_AUTHKEY

version: "3.9"

services:

  # ── Tailscale sidecar ──────────────────────────────────────────────────────
  # Joins your Tailnet and gives the app container access to your private
  # UniFi network (controllers, Access, Protect) without any open firewall ports.
  # The app container shares this container's network namespace.
  tailscale:
    image: tailscale/tailscale:stable
    container_name: toolkit-tailscale
    hostname: unifi-toolkit-vps         # Name shown in Tailscale admin
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    volumes:
      - tailscale-state:/var/lib/tailscale
      - /dev/net/tun:/dev/net/tun
    environment:
      TS_AUTHKEY:          ${TS_AUTHKEY}
      TS_EXTRA_ARGS:       "--advertise-tags=tag:vps --accept-routes"
      TS_STATE_DIR:        /var/lib/tailscale
      TS_USERSPACE:        "false"
    networks:
      - internal

  # ── UI Toolkit application ─────────────────────────────────────────────────
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: toolkit-app
    restart: unless-stopped
    # Share Tailscale's network namespace so the app can reach your Tailnet
    network_mode: "service:tailscale"
    depends_on:
      - tailscale
    volumes:
      - app-data:/app/data               # SQLite DB + Alembic state
      - ./logs:/app/logs
    environment:
      # ── Application ──────────────────────────────────────────────────────
      DATABASE_URL:              "sqlite+aiosqlite:///./data/toolkit.db"
      APP_HOST:                  "0.0.0.0"
      APP_PORT:                  "8000"
      PUBLIC_URL:                ${PUBLIC_URL}       # e.g. https://toolkit.yourdomain.com

      # ── Webhook secrets ───────────────────────────────────────────────────
      WEBHOOK_SECRET_ACCESS:     ${WEBHOOK_SECRET_ACCESS:-}
      WEBHOOK_SECRET_PROTECT:    ${WEBHOOK_SECRET_PROTECT:-}

      # ── SAML SSO (optional — leave blank to disable) ──────────────────────
      SAML_SP_ENTITY_ID:         ${SAML_SP_ENTITY_ID:-}
      SAML_SP_ACS_URL:           ${SAML_SP_ACS_URL:-}
      SAML_IDP_ENTITY_ID:        ${SAML_IDP_ENTITY_ID:-}
      SAML_IDP_SSO_URL:          ${SAML_IDP_SSO_URL:-}
      SAML_IDP_CERT:             ${SAML_IDP_CERT:-}
      SAML_ADMIN_GROUPS:         ${SAML_ADMIN_GROUPS:-}
      SAML_SESSION_HOURS:        ${SAML_SESSION_HOURS:-8}
      SAML_COOKIE_SECURE:        "true"
      SAML_STRICT:               "true"
      SAML_DEBUG:                "false"

      # ── SCIM provisioning ─────────────────────────────────────────────────
      SCIM_BEARER_TOKEN:         ${SCIM_BEARER_TOKEN:-}

      # ── Site Manager API ──────────────────────────────────────────────────
      UNIFI_API_KEY:             ${UNIFI_API_KEY:-}
      UNIFI_FABRIC_ID:           ${UNIFI_FABRIC_ID:-}
      PEOPLE_CACHE_TTL_HOURS:    ${PEOPLE_CACHE_TTL_HOURS:-1}

      # ── Tailscale / UniFi reach ───────────────────────────────────────────
      # Local UniFi controller IPs (Tailscale IPs of your on-prem machines)
      UNIFI_CONTROLLER_URL:      ${UNIFI_CONTROLLER_URL:-}
      UNIFI_USERNAME:            ${UNIFI_USERNAME:-}
      UNIFI_PASSWORD:            ${UNIFI_PASSWORD:-}

      # ── Logging ───────────────────────────────────────────────────────────
      LOG_LEVEL:                 ${LOG_LEVEL:-INFO}
      PYTHONUNBUFFERED:          "1"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/activity/api/health"]
      interval: 30s
      timeout:  10s
      retries:  3
      start_period: 20s

  # ── Nginx reverse proxy ────────────────────────────────────────────────────
  # Handles public HTTPS → proxies to app container on localhost.
  # SSL certs are obtained and renewed automatically via Certbot.
  nginx:
    image: nginx:1.25-alpine
    container_name: toolkit-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - certbot-www:/var/www/certbot:ro
      - certbot-certs:/etc/letsencrypt:ro
      - ./logs/nginx:/var/log/nginx
    depends_on:
      - tailscale
      - app
    networks:
      - internal
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 60s
      timeout:  10s
      retries:  3

  # ── Certbot (SSL cert management) ─────────────────────────────────────────
  certbot:
    image: certbot/certbot:latest
    container_name: toolkit-certbot
    volumes:
      - certbot-www:/var/www/certbot
      - certbot-certs:/etc/letsencrypt
    # Renews certs every 12h; exits immediately if not due
    entrypoint: >
      sh -c "trap exit TERM;
             while :; do
               certbot renew --webroot -w /var/www/certbot --quiet;
               sleep 12h & wait $${!};
             done"
    networks:
      - internal

volumes:
  tailscale-state:    # Tailscale auth state (persists across restarts)
  app-data:           # SQLite database + Alembic version tracking
  certbot-www:        # ACME challenge files
  certbot-certs:      # Let's Encrypt certificates

networks:
  internal:
    driver: bridge
